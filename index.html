<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FMR Staff ID Badge Generator</title>
<style>
  :root{
    --fmr-navy:#042945;
    --panel:#1e293b;
    --bg:#0f172a;
    --green:#53b76a;
    --text:#ffffff;
    --muted:#94a3b8;
    --radius-lg:.6rem; --radius-md:.4rem; --radius-sm:.25rem;
    --font:system-ui,-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }

  /* ====== LAYOUT ====== */
  body{
    margin:0; color:var(--text); background:var(--bg); font-family:var(--font);
    min-height:100vh; display:grid; grid-template-columns:460px 1fr; gap:1rem; padding:1rem;
  }
  @media (max-width: 900px){ body{ grid-template-columns:1fr; } }

  .panel{
    background:var(--panel); border-radius:var(--radius-lg); border:1px solid #47556955;
    box-shadow:0 30px 60px -10px rgba(0,0,0,.8); display:flex; flex-direction:column; max-width:460px;
  }
  .panel-header{ padding:1rem 1rem .5rem; border-bottom:1px solid #33415555; }
  .panel-header h1{ margin:0; font-size:1rem; }
  .panel-header p{ margin:.5rem 0 0; font-size:.8rem; color:var(--muted); }
  .panel-body{ padding:1rem; display:grid; gap:1rem; font-size:.85rem; }
  label{ display:flex; flex-direction:column; gap:.4rem; font-weight:600; font-size:.85rem; }
  label .hint{ font-weight:400; color:var(--muted); font-size:.75rem; }
  input, select{
    width:100%;
    background:#0b1324; border:1px solid #475569; color:var(--text); border-radius:var(--radius-md);
    padding:.65rem .7rem; font-size:.95rem; outline:none; text-overflow:ellipsis;
  }
  input:focus, select:focus{ border-color:var(--green); box-shadow:0 0 0 2px #53b76a33; }
  .btn-row{ border-top:1px solid #33415555; padding:1rem; display:flex; gap:.6rem; justify-content:flex-end; flex-wrap:wrap; }
  button{ appearance:none; border:0; border-radius:var(--radius-md); cursor:pointer; font-weight:700; font-size:.95rem; padding:.65rem 1rem; }
  #printBtn{ background:var(--green); color:#001513; }
  #clearBtn{ background:transparent; color:#a3b2c8; border:1px solid #475569; }
  #printFrontBtn, #printBackBtn{ background:#0ea5e9; color:#00121a; }

  .preview-area{ display:grid; grid-template-rows:auto 1fr; gap:1rem; min-width:0; }
  .preview-head h2{ margin:0; font-size:1rem; }
  .preview-head p{ margin:.2rem 0 0; color:var(--muted); font-size:.85rem; }
  .preview-grid{ display:flex; flex-wrap:wrap; gap:1rem; }

  /* ====== BADGE BASE ====== */
  .badge{
    width:3.375in; height:2.125in; border-radius:.4rem; border:2px solid #0f172a;
    box-sizing:border-box; position:relative; overflow:hidden;
    box-shadow:0 25px 40px -10px rgba(0,0,0,.8);
  }

  /* FRONT */
  .badge-front{
    background:
      radial-gradient(circle at 28% 18%, rgba(83,183,106,.18) 0%, transparent 60%),
      radial-gradient(circle at 72% 78%, rgba(0,75,135,.42) 0%, transparent 70%),
      var(--fmr-navy);
    display:grid; grid-template-rows:auto 1fr auto; padding:.30rem .50rem .48rem .40rem; color:#fff;
  }
  .front-header{ display:flex; gap:.5rem; align-items:flex-start; }
  .logo-wrap{ width:1.05in; display:flex; flex-direction:column; align-items:flex-start; }
  .logo-wrap img{ max-width:100%; max-height:1.0in; object-fit:contain; margin-top:-.08rem; }
  .clinic-text{ font-size:.54rem; font-weight:700; text-transform:uppercase; }
  .clinic-text small{ display:block; color:#cbd5e1; font-size:.42rem; font-style:italic; margin-top:.15rem; font-weight:500; }

  .front-body{ display:grid; grid-template-columns:auto 1fr; gap:.45rem; align-items:flex-start; margin-top:.10rem; }
  .photo-frame{
    width:1in; height:1.25in;
    background:transparent; border:none; border-radius:.15rem; position:relative;
    margin-bottom:.50in; /* keep photo 1/2″ above the bottom edge */
  }
  .photo-wrap{ position:absolute; inset:.04in .04in .06in .04in; overflow:hidden; border-radius:.12rem; }
  .photo-frame img{ position:absolute; left:50%; top:50%; width:100%; height:100%; object-fit:cover; transform:translate(-50%,-50%) scale(1); border-radius:.12rem; }
  #photoFallback{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:.45rem; text-align:center; padding:.2rem; }

  /* --- TEXT BLOCK (name/role/id) BELOW THE QR --- */
  /* === Put name/role/ID just below the QR, but keep it visible === */
.id-info{
  margin-top: 0.72in !important;   /* was 1.05in; adjust 0.65–0.80in to taste */
  max-width: calc(100% - 1.15in) !important;  /* keep text out from under the QR */
}
/* make sure the grid doesn't fight our offset */
.front-body{ align-items: flex-start !important; }

  .emp-name{ font-size:9pt; font-weight:800; line-height:1.06; margin:0 0 .06rem 0; }
  .emp-role{ font-size:9pt; color:var(--green); margin-top:.04rem; font-weight:700; }
  .emp-idline{ font-size:9pt; color:#cbd5e1; margin-top:.04rem; }

  .front-footer{ display:flex; justify-content:space-between; align-items:flex-end; font-size:.38rem; color:#cbd5e1; margin-top:.28rem; }
  .dept{ color:#fff; font-weight:800; font-size:.42rem; }

  .qr-float{ position:absolute; right:.35rem; top:1.15rem; } /* QR position */
  .qr-box{
    width:1.0in; height:1.0in; background:#fff; border-radius:.15rem;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
    box-shadow:none; border:1px solid #e2e8f0;
  }
  .qr-box canvas, .qr-box img{ width:100%; height:100%; }
  .barcode-box{
    width:1.0in; height:1.0in; background:#fff; border-radius:.15rem;
    display:none; align-items:center; justify-content:center; overflow:hidden;
    box-shadow:none; border:1px solid #e2e8f0;
  }
  .barcode-box svg{ width:92%; height:92%; }

  /* BACK */
  .badge-back{ background:#fff; color:#0f172a; border:2px solid #0f172a; display:flex; flex-direction:column; justify-content:space-between; padding:.5rem .5rem .4rem; }
  .back-header{ font-size:.5rem; font-weight:800; color:#042945; }
  .clinic-name{ text-transform:uppercase; letter-spacing:.04em; }
  .md-line{ font-size:.45rem; color:#2563eb; font-weight:600; }
  .back-hdr-extra{ margin-top:.3rem; font-size:.45rem; font-weight:600; color:#1e293b; }
  .back-body{ font-size:.4rem; line-height:1.45; color:#1e293b; }
  .label{ font-weight:800; color:#000; }
  .back-footer{ font-size:.35rem; color:#475569; border-top:1px solid #94a3b8; padding-top:.3rem; }

  /* ====== PRINT ====== */
  @media print{
    @page { size: 3.375in 2.125in; margin: 0; }
    body.print-front .badge-back { display: none !important; }
    body.print-back  .badge-front{ display: none !important; }

    body{ background:#fff !important; color:#000 !important; display:block !important; padding:0 !important; margin:0 !important; }
    .panel, .preview-head{ display:none !important; }
    .preview-area{ margin:0 !important; }
    .preview-grid{ display:block !important; }
    .badge{ page-break-inside:avoid; box-shadow:none !important; border:1px solid #000; }
  }
</style>
</head>
<body>

  <!-- ====== LEFT CONTROL PANEL ====== -->
  <section class="panel">
    <div class="panel-header">
      <h1>FMR Badge Generator</h1>
      <p>Select an employee, adjust fields if needed, then click <strong>Print</strong>.<br />
      This page reads <code>employees.json</code> and uses <code>fmr-logo.png</code>.<br />
      Photos are NOT uploaded; local FileReader renders them just for printing.</p>
    </div>
    <div class="panel-body">
      <label>
        Employee <span class="hint">Dropdown is loaded from employees.json</span>
        <select id="employeeSelect"></select>
      </label>

      <label>
        ID #
        <input id="empId" placeholder="###" />
      </label>

      <label>
        Title / Role
        <input id="empRole" placeholder="Clinical Assistant" />
      </label>

      <label>
        Office / Site
        <input id="empOffice" placeholder="Carson, CA" />
      </label>

      <label>
        Back of badge address
        <select id="addrSelect">
          <option value="carson" selected>Carson – 20620 Leapwood Ave Unit H, Carson, CA 90746</option>
          <option value="downey">Downey – 12115 Paramount Blvd, Downey, CA 90242</option>
          <option value="westcovina">West Covina – 1900 W Garvey Ave South, Suite 223, West Covina, CA 91790</option>
          <option value="koreatown">Koreatown – 2970 W Olympic Blvd Suite 304, Los Angeles, CA 90006</option>
        </select>
      </label>

      <label>
        Code type
        <select id="codeType">
          <option value="qr" selected>QR Code</option>
          <option value="barcode">Barcode (Code128)</option>
        </select>
      </label>

      <label>
        Upload headshot (local only)
        <span class="hint">Image stays in your browser; not uploaded anywhere</span>
        <input id="photoInput" type="file" accept="image/*" />
      </label>

      <label>
        Photo note
        <span class="hint">Printed badge shows this text if no photo is loaded</span>
        <input id="empPhotoNote" placeholder="STAFF PHOTO" />
      </label>
    </div>
    <div class="btn-row">
      <button id="printFrontBtn">Print Fronts</button>
      <button id="printBackBtn">Print Backs</button>
      <button id="printBtn">Print Badge</button>
      <button id="clearBtn">Clear</button>
    </div>
  </section>

  <!-- ====== RIGHT PREVIEW AREA ====== -->
  <section class="preview-area">
    <div class="preview-head">
      <h2>Preview</h2>
      <p>Front (left) and back (right) — actual CR80 size (3.375in × 2.125in).</p>
    </div>

    <div class="preview-grid">
      <!-- FRONT -->
      <section class="badge badge-front" id="badgeFront">
        <div class="front-header">
          <div class="logo-wrap">
            <img src="fmr-logo.png" alt="FMR Logo" />
          </div>
          <div class="clinic-text">
            INTERVENTIONAL QUALITY<br/>PAIN MANAGEMENT
            <small>F. Marina Russman, MD</small>
          </div>
        </div>

        <div class="front-body">
          <div class="photo-frame" id="photoFrame">
            <div class="photo-wrap">
              <img id="photoImg" alt="Staff photo" style="display:none;" />
            </div>
            <div id="photoFallback">STAFF PHOTO</div>
          </div>
          <div class="id-info">
            <div class="emp-name" id="outName">Employee Name</div>
            <div class="emp-role" id="outRole">Clinical Assistant</div>
            <div class="emp-idline" id="outIdLine">ID: ###</div>
          </div>
        </div>

        <div class="front-footer">
          <div>
            <div class="dept" id="outDept">Pain Management Clinic</div>
            <div id="outOffice">Carson, CA</div>
          </div>
        </div>

        <!-- Code image (QR or barcode) -->
        <div class="qr-float">
          <div id="qrBox" class="qr-box"></div>
          <div id="barcodeBox" class="barcode-box"><svg id="barcode"></svg></div>
        </div>
      </section>

      <!-- BACK -->
      <section class="badge badge-back" id="badgeBack">
        <div class="back-header">
          <div class="clinic-name">FMR Interventional Quality Pain Management</div>
          <div class="md-line">F. Marina Russman, MD – Medical Director</div>
          <div class="back-hdr-extra">
            Clinic: <span id="backPhone">(310) 294-9027</span><br/>
            Address: <span id="backAddress">20620 Leapwood Ave Unit H, Carson, CA 90746</span>
          </div>
        </div>
        <div class="back-body">
          <div class="label">Authorized Staff Member</div>
          The individual wearing this badge is employed by FMR Interventional Quality Pain Management and may have access to confidential health information for treatment and care coordination purposes.
          <br/><br/>
          <div class="label">If Found</div>
          Please return to the clinic listed above. This badge is non-transferable. Unauthorized use is prohibited.
        </div>
        <div class="back-footer">HIPAA Notice: This identification card may allow access to Protected Health Information (PHI). Loss or misuse must be reported immediately to clinic administration.</div>
      </section>
    </div>
  </section>

  <!-- QR + Barcode libraries (MIT) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <script>
    // ====== ELEMENTS ======
    const employeeSelect = document.getElementById('employeeSelect');
    const empId = document.getElementById('empId');
    const empRole = document.getElementById('empRole');
    const empOffice = document.getElementById('empOffice');
    const empPhotoNote = document.getElementById('empPhotoNote');
    const addrSelect = document.getElementById('addrSelect');
    const codeType = document.getElementById('codeType');

    const outName = document.getElementById('outName');
    const outRole = document.getElementById('outRole');
    const outIdLine = document.getElementById('outIdLine');
    const outDept = document.getElementById('outDept');
    const outOffice = document.getElementById('outOffice');

    const backPhone = document.getElementById('backPhone');
    const backAddress = document.getElementById('backAddress');

    const qrBox = document.getElementById('qrBox');
    const barcodeBox = document.getElementById('barcodeBox');
    const barcodeSvg = document.getElementById('barcode');

    const photoInput = document.getElementById('photoInput');
    const photoImg = document.getElementById('photoImg');
    const photoFallback = document.getElementById('photoFallback');

    // ====== CONSTANTS ======
    const CLINIC_PHONE = '(310) 294-9027';
    const ADDRESSES = {
      carson: '20620 Leapwood Ave Unit H, Carson, CA 90746',
      downey: '12115 Paramount Blvd, Downey, CA 90242',
      westcovina: '1900 W Garvey Ave South, Suite 223, West Covina, CA 91790',
      koreatown: '2970 W Olympic Blvd Suite 304, Los Angeles, CA 90006'
    };
    const SHORT_OFFICE = {
      carson: 'Carson, CA',
      downey: 'Downey, CA',
      westcovina: 'West Covina, CA',
      koreatown: 'Koreatown, Los Angeles, CA'
    };
    backPhone.textContent = CLINIC_PHONE;

    // ====== QR / BARCODE ======
    function buildQrPayload(){
      const name = employeeSelect.value || 'Employee';
      theId = empId.value || '###';
      const title = empRole.value || 'Clinical Assistant';
      const office = (empOffice.value || SHORT_OFFICE.carson).replace(/,/g, '');
      const today = new Date().toISOString().slice(0,10);
      return `FMR|${theId}|${name}|${title}|${office}|${today}`;
    }
    function renderQR(){
      const payload = buildQrPayload();
      qrBox.innerHTML = '';
      new QRCode(qrBox, { text: payload, width:256, height:256, correctLevel: QRCode.CorrectLevel.M });
    }
    function renderBarcode(){
      const idVal = empId.value || '###';
      const payload = 'FMR-' + idVal;
      try { JsBarcode(barcodeSvg, payload, { format:'CODE128', displayValue:true, fontSize:12, margin:2 }); }
      catch(e){ console.error('Barcode error', e); }
    }
    function renderCode(){
      if(codeType.value === 'barcode'){
        barcodeBox.style.display = 'flex';
        qrBox.style.display = 'none';
        renderBarcode();
      } else {
        barcodeBox.style.display = 'none';
        qrBox.style.display = 'flex';
        renderQR();
      }
    }

    // ====== PREVIEW UPDATE ======
    function updatePreview(){
      const name = employeeSelect.value || 'Employee Name';
      const role = empRole.value || 'Clinical Assistant';
      const theId = empId.value || '###';
      const officeVal = empOffice.value || SHORT_OFFICE.carson;
      const photoText = empPhotoNote.value || 'STAFF PHOTO';

      outName.textContent = name;
      outRole.textContent = role;
      outIdLine.textContent = `ID: ${theId}`;
      outDept.textContent = 'Pain Management Clinic';
      outOffice.textContent = officeVal;

      if(photoImg && photoImg.style.display !== 'block'){
        photoFallback.textContent = photoText;
        photoFallback.style.display = 'flex';
      }
      renderCode();
    }

    function clearAll(){
      employeeSelect.selectedIndex = -1;
      empId.value = '';
      empRole.value = '';
      empOffice.value = '';
      empPhotoNote.value = '';
      codeType.value = 'qr';
      addrSelect.value = 'carson';
      backAddress.textContent = ADDRESSES.carson;
      outOffice.textContent = SHORT_OFFICE.carson;
      if(photoImg){ photoImg.removeAttribute('src'); photoImg.style.display='none'; }
      if(photoFallback){ photoFallback.style.display='flex'; }
      updatePreview();
    }

    // Keep front office text in sync when the address dropdown changes
    addrSelect.addEventListener('change', () => {
      const key = addrSelect.value;
      backAddress.textContent = ADDRESSES[key] || ADDRESSES.carson;
      empOffice.value = SHORT_OFFICE[key] || SHORT_OFFICE.carson;
      outOffice.textContent = empOffice.value;
      updatePreview();
    });

    // ====== EVENTS ======
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    [empId, empRole, empOffice, empPhotoNote].forEach(el => el.addEventListener('input', updatePreview));
    codeType.addEventListener('change', updatePreview);

    // Local photo upload (stays in browser)
    function setPhotoFromFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        if (photoImg) { photoImg.src = e.target.result; photoImg.style.display = 'block'; }
        if (photoFallback) { photoFallback.style.display = 'none'; }
      };
      reader.readAsDataURL(file);
    }
    if (photoInput) {
      photoInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        setPhotoFromFile(file);
      });
    }

    // ====== LOAD EMPLOYEES ======
    async function loadEmployees(){
      let list = [];
      try{
        const res = await fetch('employees.json?cb=' + Date.now(), { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        list = await res.json();
      }catch(e){ console.error('Error loading employees.json:', e); }

      if(!Array.isArray(list) || list.length === 0){
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = '— no employees found —';
        employeeSelect.appendChild(opt); updatePreview(); return;
      }

      list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      list.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.name || '';
        opt.textContent = (emp.name || 'Unknown') + (emp.title ? (' — ' + emp.title) : '');
        opt.dataset.role = emp.title || '';
        opt.dataset.id = emp.id || '';
        opt.dataset.office = emp.office || '';
        employeeSelect.appendChild(opt);
      });

      employeeSelect.addEventListener('change', () => {
        const o = employeeSelect.options[employeeSelect.selectedIndex]; if(!o) return;
        empRole.value   = o.dataset.role || '';
        empId.value     = o.dataset.id || '';
        empOffice.value = o.dataset.office ? (o.dataset.office + ', CA') : '';

        const office = (o.dataset.office || '').toLowerCase();
        if(office.includes('carson'))       addrSelect.value = 'carson';
        else if(office.includes('downey'))  addrSelect.value = 'downey';
        else if(office.includes('west covina') || office.includes('westcovina')) addrSelect.value = 'westcovina';
        else if(office.includes('koreatown') || office.includes('korea town'))    addrSelect.value = 'koreatown';

        const key = addrSelect.value;
        backAddress.textContent = ADDRESSES[key];
        empOffice.value = SHORT_OFFICE[key];
        outOffice.textContent = SHORT_OFFICE[key];

        updatePreview();
      });

      // Initialize defaults
      empOffice.value = SHORT_OFFICE.carson;
      backAddress.textContent = ADDRESSES.carson;
      updatePreview();
    }
    loadEmployees();

    // ====== TARGETED PRINT (FRONTS/BACKS) ======
    function printSide(side){
      document.body.classList.remove('print-front','print-back');
      if(side === 'front') document.body.classList.add('print-front');
      if(side === 'back')  document.body.classList.add('print-back');

      const cleanup = () => document.body.classList.remove('print-front','print-back');
      if ('onafterprint' in window) {
        const handler = () => { cleanup(); window.removeEventListener('afterprint', handler); };
        window.addEventListener('afterprint', handler);
      } else {
        setTimeout(cleanup, 1200);
      }
      window.print();
    }
    document.getElementById('printFrontBtn').addEventListener('click', () => printSide('front'));
    document.getElementById('printBackBtn').addEventListener('click',  () => printSide('back'));
  </script>
</body>
</html>
